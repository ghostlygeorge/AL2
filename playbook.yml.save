- name: CIS hardening.
  hosts: all
  become: yes

  roles:
    - amazon_linux_cis_hardening

  tasks:
    - name: Copy agent to the remote host
      ansible.builtin.copy:
        src: /opt/Devsecops/ansible/AL23_25/falcon-sensor-7.24.0-17706.amzn2023.aarch64.rpm
        dest: /tmp/
        mode: '0644'

    - name: Install Falcon agent
      ansible.builtin.yum:
        name: /tmp/falcon-sensor-7.24.0-17706.amzn2023.aarch64.rpm
        state: present
        disable_gpg_check: yes

    - name: Register Falcon agent with CCID
      ansible.builtin.command: >
        /opt/CrowdStrike/falconctl -s --cid={{ falcon_ccid }} -f
      args:
        creates: /opt/CrowdStrike/falconhoseclient.db
      notify:
        - Start falcon-sensor

    - name: Enable Falcon service for autostart
      ansible.builtin.systemd:
        name: falcon-sensor
        enabled: true   # start at boot/restart

    - name: Delete Falcon agent installer
      ansible.builtin.file:
        path: /tmp/falcon-sensor.rpm
        state: absent
    - name: Ensure repo_gpgcheck=0 in yum/dnf configuration files
      lineinfile:
        path: "{{ item }}"
        regexp: '^repo_gpgcheck='
        line: 'repo_gpgcheck=0'
        state: present
        create: no
      with_fileglob:
        - /etc/yum.conf
        - /etc/yum.repos.d/*.repo
        - /etc/dnf/dnf.conf
      when: ansible_facts['os_family'] == "RedHat"
      tags:
        - repo_gpgcheck

    - name: Remove root authorized keys
      ansible.builtin.file:
        path: /root/.ssh/authorized_keys
        state: absent

    - name: Remove default user authorized keys (Amazon Linux usually 'ec2-user')
      ansible.builtin.file:
        path: /home/ec2-user/.ssh/authorized_keys
        state: absent
      ignore_errors: yes

    - name: Remove SSH host keys
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      loop:
        - /etc/ssh/ssh_host_rsa_key
        - /etc/ssh/ssh_host_rsa_key.pub
        - /etc/ssh/ssh_host_ecdsa_key
        - /etc/ssh/ssh_host_ecdsa_key.pub
        - /etc/ssh/ssh_host_ed25519_key
        - /etc/ssh/ssh_host_ed25519_key.pub

    - name: Clear shell history
      ansible.builtin.shell: history -c && history -w
      args:
        removes: /root/.bash_history
      ignore_errors: yes

  handlers:
    - name: Start falcon-sensor
      ansible.builtin.service:
        name: falcon-sensor
        state: started
        enabled: yes
