- name: "2.1.1.3 Ensure chrony is configured"
  block:
    - name: "Identify package manager"
      package_facts:
        manager: yum

    - name: "Install chrony (yum)"
      package:
        name: chrony
        state: present
      when: ansible_facts.pkg_mgr == "yum"

    - name: "Install chrony (dnf)"
      package:
        name: chrony
        state: present
      when: ansible_facts.pkg_mgr == "dnf"

    - name: "Fail if package manager unknown"
      fail:
        msg: "Unsupported package manager - cannot install chrony"
      when: ansible_facts.pkg_mgr not in ["yum", "dnf"]

    - name: "Configure chrony"
      template:
        src: chrony.conf.j2
        dest: /etc/chrony.conf
        owner: root
        group: root
        mode: 0640
      notify: restart chronyd

    - name: "Enable and start chronyd service"
      service:
        name: chronyd
        state: started
        enabled: yes

  rescue:
    - name: "Log and skip chrony setup due to package manager detection failure"
      debug:
        msg: "Skipping chrony setup â€” package manager detection failed."

  tags:
    - chrony
    - ntp

